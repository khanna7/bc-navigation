---
title: "Analysis of Diagnostic Referral Completion"
author: "Bryan Brickman"
date: "2/17/2021"
output: html_document
---
---
title: "Analysis of disgnostic referral completion"
output:
  pdf_document: default
  html_document:
    df_print: paged
---
```{r}
library(dplyr)
library(ggplot2)
```


Intro:
I have implemented a method to analyze diagnostic referrrals. I output events to a file whenever an agent loses their diagnostic referral (by expiration or completion, deaths are excluded for simplicity). 

This file records the timestep, length of referral at the time of referral loss, whether the referral expired, and whether the length from referral to diagnosis is less than or equal to 2 months/60 days.

In this document I will show the results from analyzing the original model parameters as well as a modified version of the model which increases the probability of diagnostic test completion in months 1 and 2 of the referral.

Loading in data:
```{r}
bc_navigation_root <- '/project2/khanna7/bryanb/bc-navigation/dec9_navlength/bc-navigation/'
#old_referral_data <- read.table(paste0(bc_navigation_root,"1.dtdata"))
#colnames(old_referral_data)<-c("time","diagnostic_referral_length","expired","within_2_months")

referral_data <- read.table(paste0(bc_navigation_root,"1.dtdata"))
colnames(referral_data)<-c("time","diagnostic_referral_length","expired","within_2_months")

```


Taking a peek at the data format:
```{r}
referral_data[1:15,]
```

Note that we see 3570 and 3765 rows, corresponding to 3570/3765 agents losing their diagnostic referral through completion or expiration. The model was run for 360 months / 30 years.
```{r}
#old_total <- length(old_referral_data$time)
new_total <- length(referral_data$time)
```


Plotting frequencies of length of referral (this is plotting the data with expirations filtered out):
```{r}
#hist(filter(old_referral_data, diagnostic_referral_length > 0)$diagnostic_referral_length)
```

```{r}
hist(filter(referral_data, diagnostic_referral_length > 0)$diagnostic_referral_length)
```


These histograms show the agents who lost referrals due to completion.
Looking at the 2 month completion rate we see the original has a rate of:
```{r}
#length(filter(old_referral_data, within_2_months == 1)$within_2_months)/old_total
```

And the new data has a rate of:
```{r}
length(filter(referral_data, within_2_months == 1)$within_2_months)/new_total

```

We accomplished this by setting the "probability" (from Micky's Prob.R file) from =0.0034 to =0.01 when the referral length of an agent is 1 or 2. Further increase will probably be able to yield a 2 month completion rate of 75% as desired.

Next we can look at the overall breakdown between expirations and completions. Dividing by the total number of events from earlier, we can figure out what portion of referrals got completed:
```{r}
#n_old_completed <- length(which(old_referral_data[2] > 0))
#n_old_completed
```
```{r}
#old_completion_rate <- n_old_completed/old_total
#old_completion_rate
```

```{r}
n_new_completed <- length(which(referral_data[2] > 0))
n_new_completed
```
```{r}
new_completion_rate <- n_new_completed/new_total
new_completion_rate
```


This shows that the original completion rate is 64% and the new is 75%.

We can compare this to other ratios, like the expiration rate (flagged with a length of -1):
```{r}
#n_old_expired <- length(which(old_referral_data[2] == -1))
#n_old_expired
```
```{r}
#old_expiry_rate <- n_old_expired/old_total
#old_expiry_rate
```
```{r}
n_new_expired <- length(which(referral_data[2] == -1))
n_new_expired
```
```{r}
new_expiry_rate <- n_new_expired/new_total
new_expiry_rate
```

```{r}
#old_completion_rate + old_expiry_rate
```
```{r}
new_completion_rate + new_expiry_rate
```

Seems like the numbers all add up!


Finally, look at expirations over time as a sanity check. Notice that months 1-12 contain no expirations(as expected):
```{r}
#ggplot(data=filter(old_referral_data, diagnostic_referral_length == -1))+
#  geom_histogram(aes(x=time), bins = 180)
```

```{r}
ggplot(data=filter(referral_data, diagnostic_referral_length == -1))+
  geom_histogram(aes(x=time),bins = 180)
```
